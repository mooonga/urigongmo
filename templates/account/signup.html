{% extends 'base.html' %}
{% load static %}

{% block title %}회원가입 – 우리동네공모전{% endblock %}

{% block content %}
<main class="login-section">
  <div class="login-card">
    <h2 class="auth-heading">회원가입</h2>

    <!-- 오류 메시지 출력 블록 -->
    {% if form.errors %}
      <div class="form-errors" style="color: red; margin-bottom: 1rem;">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" class="auth-form">
      {% csrf_token %}

      <!-- 회원 분류 -->
      <div class="form-group">
        <label for="id_role">회원 분류 <small style="color: gray;">(필수)</small></label>
        <div class="select-wrapper">
          <select name="role" id="id_role" class="user-type-select" required>
            <option value="admin">일반 회원</option>
            <option value="business">사업체</option>
          </select>
        </div>
      </div>

      <!-- 닉네임 -->
      <div class="form-group">
        <label for="{{ form.nickname.id_for_label }}">
          닉네임 <small style="color: gray;">(필수, 최대 30자, 중복 불가)</small>
        </label>
        <div class="input-with-button">
          {{ form.nickname }}
          <button type="button" class="check-email" onclick="checkNickname()">중복확인</button>
        </div>
        <span id="nickname-message" style="font-size: 0.9em;"></span>
      </div>

      <!-- 이메일 -->
      <div class="form-group">
        <label for="{{ form.email.id_for_label }}">
          이메일 <small style="color: gray;">(필수, 이메일 형식, 중복 불가)</small>
        </label>
        <div class="input-with-button">
          {{ form.email }}
          <button type="button" class="check-email" onclick="checkEmail()">중복확인</button>
        </div>
        <span id="email-message" style="font-size: 0.9em;"></span>
      </div>

      <!-- 비밀번호 -->
      <div class="form-group">
        <label for="{{ form.password1.id_for_label }}">
          비밀번호 <small style="color: gray;">(필수, 8자 이상, 숫자/문자 포함 권장)</small>
        </label>
        {{ form.password1 }}
      </div>

      <!-- 비밀번호 확인 -->
      <div class="form-group">
        <label for="{{ form.password2.id_for_label }}">
          비밀번호 확인 <small style="color: gray;">(반드시 위와 동일)</small>
        </label>
        {{ form.password2 }}
        <p id="pw-match-msg" style="margin-top: 4px;"></p>
      </div>

      <button type="submit" class="login-submit">회원가입</button>
    </form>

    <div class="login-footer auth-footer-links">
      <a href="{% url 'account:login' %}">로그인</a>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
  function checkNickname() {
    const nickname = document.getElementById("id_nickname").value;
    const msg = document.getElementById("nickname-message");

    fetch(`/account/ajax/check_nickname/?nickname=${nickname}`)
      .then(response => response.json())
      .then(data => {
        msg.textContent = data.message;
        msg.style.color = data.exists ? "red" : "green";
      });
  }

  function checkEmail() {
    const email = document.getElementById("id_email").value;
    const msg = document.getElementById("email-message");

    fetch(`/account/ajax/check_email/?email=${email}`)
      .then(response => response.json())
      .then(data => {
        msg.textContent = data.message;
        msg.style.color = data.exists ? "red" : "green";
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const pw1 = document.getElementById("id_password1");
    const pw2 = document.getElementById("id_password2");
    const msg = document.getElementById("pw-match-msg");

    pw2.addEventListener("input", () => {
      if (pw2.value !== pw1.value) {
        msg.textContent = "비밀번호가 일치하지 않습니다.";
        msg.style.color = "red";
      } else {
        msg.textContent = "비밀번호가 일치합니다.";
        msg.style.color = "green";
      }
    });
  });
</script>
{% endblock %}